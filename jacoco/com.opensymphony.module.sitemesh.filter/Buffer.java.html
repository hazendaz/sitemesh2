<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Buffer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sitemesh</a> &gt; <a href="index.source.html" class="el_package">com.opensymphony.module.sitemesh.filter</a> &gt; <span class="el_source">Buffer.java</span></div><h1>Buffer.java</h1><pre class="source lang-java linenums">/*
 * sitemesh2 (https://github.com/hazendaz/sitemesh2)
 *
 * Copyright 2011-2023 Hazendaz.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of The Apache Software License,
 * Version 2.0 which accompanies this distribution, and is available at
 * https://www.apache.org/licenses/LICENSE-2.0.txt
 *
 * Contributors:
 *     Hazendaz (Jeremy Landis).
 */
/* This software is published under the terms of the OpenSymphony Software
 * License version 1.1, of which a copy has been included with this
 * distribution in the LICENSE.txt file. */
package com.opensymphony.module.sitemesh.filter;

import com.opensymphony.module.sitemesh.DefaultSitemeshBuffer;
import com.opensymphony.module.sitemesh.Page;
import com.opensymphony.module.sitemesh.PageParser;
import com.opensymphony.module.sitemesh.SitemeshBuffer;
import com.opensymphony.module.sitemesh.SitemeshBufferWriter;
import com.opensymphony.module.sitemesh.util.FastByteArrayOutputStream;

import jakarta.servlet.ServletOutputStream;
import jakarta.servlet.WriteListener;

import java.io.IOException;
import java.io.PrintWriter;

/**
 * When SiteMesh is activated for a request, the contents of the response are stored in this buffer, where they can
 * later be accessed as a parsed Page object.
 *
 * @author Joe Walnes
 */
public class Buffer {

    /** The page parser. */
    private final PageParser pageParser;

    /** The encoding. */
    private final String encoding;

    /** The Constant TEXT_ENCODER. */
<span class="nc" id="L47">    private static final TextEncoder TEXT_ENCODER = new TextEncoder();</span>

    /** The buffered writer. */
    private SitemeshBufferWriter bufferedWriter;

    /** The buffered stream. */
    private FastByteArrayOutputStream bufferedStream;

    /** The exposed writer. */
    private PrintWriter exposedWriter;

    /** The exposed stream. */
    private ServletOutputStream exposedStream;

    /**
     * Instantiates a new buffer.
     *
     * @param pageParser
     *            the page parser
     * @param encoding
     *            the encoding
     */
<span class="nc" id="L69">    public Buffer(PageParser pageParser, String encoding) {</span>
<span class="nc" id="L70">        this.pageParser = pageParser;</span>
<span class="nc" id="L71">        this.encoding = encoding;</span>
<span class="nc" id="L72">    }</span>

    /**
     * Gets the contents.
     *
     * @return the contents
     *
     * @throws IOException
     *             Signals that an I/O exception has occurred.
     */
    public SitemeshBuffer getContents() throws IOException {
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (bufferedWriter != null) {</span>
<span class="nc" id="L84">            return bufferedWriter.getSitemeshBuffer();</span>
        }
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (bufferedStream != null) {</span>
<span class="nc" id="L87">            return new DefaultSitemeshBuffer(TEXT_ENCODER.encode(bufferedStream.toByteArray(), encoding));</span>
        } else {
<span class="nc" id="L89">            return new DefaultSitemeshBuffer(new char[0]);</span>
        }
    }

    /**
     * Parses the.
     *
     * @return the page
     *
     * @throws IOException
     *             Signals that an I/O exception has occurred.
     */
    public Page parse() throws IOException {
<span class="nc" id="L102">        return pageParser.parse(getContents());</span>
    }

    /**
     * Gets the writer.
     *
     * @return the writer
     */
    public PrintWriter getWriter() {
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (bufferedWriter == null) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (bufferedStream != null) {</span>
<span class="nc" id="L113">                throw new IllegalStateException(&quot;response.getWriter() called after response.getOutputStream()&quot;);</span>
            }
<span class="nc" id="L115">            bufferedWriter = new SitemeshBufferWriter(128);</span>
<span class="nc" id="L116">            exposedWriter = new SitemeshPrintWriter(bufferedWriter);</span>
        }
<span class="nc" id="L118">        return exposedWriter;</span>
    }

    /**
     * Gets the output stream.
     *
     * @return the output stream
     */
    public ServletOutputStream getOutputStream() {
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (bufferedStream == null) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            if (bufferedWriter != null) {</span>
<span class="nc" id="L129">                throw new IllegalStateException(&quot;response.getOutputStream() called after response.getWriter()&quot;);</span>
            }
<span class="nc" id="L131">            bufferedStream = new FastByteArrayOutputStream();</span>
<span class="nc" id="L132">            exposedStream = new ServletOutputStream() {</span>
                @Override
                public void write(int b) {
<span class="nc" id="L135">                    bufferedStream.write(b);</span>
<span class="nc" id="L136">                }</span>

                @Override
                public boolean isReady() {
<span class="nc" id="L140">                    return false;</span>
                }

                @Override
                public void setWriteListener(WriteListener writeListener) {
                    // TODO Not implemented
<span class="nc" id="L146">                }</span>
            };
        }
<span class="nc" id="L149">        return exposedStream;</span>
    }

    /**
     * Checks if is using stream.
     *
     * @return true, if is using stream
     */
    public boolean isUsingStream() {
<span class="nc bnc" id="L158" title="All 2 branches missed.">        return bufferedStream != null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>