<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomTag.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sitemesh</a> &gt; <a href="index.source.html" class="el_package">com.opensymphony.module.sitemesh.html</a> &gt; <span class="el_source">CustomTag.java</span></div><h1>CustomTag.java</h1><pre class="source lang-java linenums">/*
 * sitemesh2 (https://github.com/hazendaz/sitemesh2)
 *
 * Copyright 2011-2023 Hazendaz.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of The Apache Software License,
 * Version 2.0 which accompanies this distribution, and is available at
 * https://www.apache.org/licenses/LICENSE-2.0.txt
 *
 * Contributors:
 *     Hazendaz (Jeremy Landis).
 */
package com.opensymphony.module.sitemesh.html;

import com.opensymphony.module.sitemesh.DefaultSitemeshBuffer;
import com.opensymphony.module.sitemesh.SitemeshBufferFragment;
import com.opensymphony.module.sitemesh.html.tokenizer.Parser;
import com.opensymphony.module.sitemesh.html.util.StringSitemeshBuffer;

import java.io.StringWriter;
import java.util.Arrays;

/**
 * A CustomTag provides a mechanism to manipulate the contents of a Tag. The standard Tag implementations are immutable,
 * however CustomTag allows a copy to be taken of an immutable Tag that can then be manipulated.
 *
 * @author Joe Walnes
 *
 * @see Tag
 */
public class CustomTag implements Tag {

    /** The attributes. */
<span class="fc" id="L35">    private String[] attributes = new String[10]; // name1, value1, name2, value2...</span>

    /** The attribute count. */
<span class="fc" id="L38">    private int attributeCount = 0;</span>

    /** The name. */
    private String name;

    /** The type. */
    private int type;

    /**
     * Type of tag: &lt;br/&gt;
     * &amp;lt;blah&amp;gt; - Tag.OPEN&lt;br/&gt;
     * &amp;lt;/blah&amp;gt; - Tag.CLOSE&lt;br/&gt;
     * &amp;lt;blah/&amp;gt; - Tag.EMPTY&lt;br/&gt;
     *
     * @param name
     *            the name
     * @param type
     *            the type
     */
<span class="fc" id="L57">    public CustomTag(String name, int type) {</span>
<span class="fc" id="L58">        setName(name);</span>
<span class="fc" id="L59">        setType(type);</span>
<span class="fc" id="L60">    }</span>

    /**
     * Create a CustomTag based on an existing Tag - this takes a copy of the Tag.
     *
     * @param tag
     *            the tag
     */
<span class="fc" id="L68">    public CustomTag(Tag tag) {</span>
<span class="fc" id="L69">        setName(tag.getName());</span>
<span class="fc" id="L70">        setType(tag.getType());</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        if (tag instanceof Parser.ReusableToken) {</span>
<span class="fc" id="L72">            Parser.ReusableToken orig = (Parser.ReusableToken) tag;</span>
<span class="fc" id="L73">            attributeCount = orig.attributeCount;</span>
<span class="fc" id="L74">            attributes = new String[attributeCount];</span>
<span class="fc" id="L75">            System.arraycopy(orig.attributes, 0, attributes, 0, attributeCount);</span>
<span class="pc bnc" id="L76" title="All 2 branches missed.">        } else if (tag instanceof CustomTag) {</span>
<span class="nc" id="L77">            CustomTag orig = (CustomTag) tag;</span>
<span class="nc" id="L78">            attributeCount = orig.attributeCount;</span>
<span class="nc" id="L79">            attributes = new String[attributeCount];</span>
<span class="nc" id="L80">            System.arraycopy(orig.attributes, 0, attributes, 0, attributeCount);</span>
<span class="nc" id="L81">        } else {</span>
<span class="nc" id="L82">            int c = tag.getAttributeCount();</span>
<span class="nc" id="L83">            attributes = new String[c * 2];</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            for (int i = 0; i &lt; c; i++) {</span>
<span class="nc" id="L85">                attributes[attributeCount++] = tag.getAttributeName(i);</span>
<span class="nc" id="L86">                attributes[attributeCount++] = tag.getAttributeValue(i);</span>
            }
        }
<span class="fc" id="L89">    }</span>

    @Override
    public String getContents() {
<span class="fc" id="L93">        SitemeshBufferFragment.Builder buffer = SitemeshBufferFragment.builder()</span>
<span class="fc" id="L94">                .setBuffer(new DefaultSitemeshBuffer(new char[] {}));</span>
<span class="fc" id="L95">        writeTo(buffer, 0);</span>
<span class="fc" id="L96">        return buffer.build().getStringContent();</span>
    }

    @Override
    public void writeTo(SitemeshBufferFragment.Builder buffer, int position) {
<span class="fc" id="L101">        StringWriter out = new StringWriter();</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">        if (type == Tag.CLOSE) {</span>
<span class="fc" id="L103">            out.append(&quot;&lt;/&quot;);</span>
        } else {
<span class="fc" id="L105">            out.append('&lt;');</span>
        }

<span class="fc" id="L108">        out.append(name);</span>
<span class="fc" id="L109">        final int len = attributeCount;</span>

<span class="fc bfc" id="L111" title="All 2 branches covered.">        for (int i = 0; i &lt; len; i += 2) {</span>
<span class="fc" id="L112">            final String name = attributes[i];</span>
<span class="fc" id="L113">            final String value = attributes[i + 1];</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">            if (value == null) {</span>
<span class="fc" id="L115">                out.append(' ').append(name);</span>
            } else {
<span class="fc" id="L117">                out.append(' ').append(name).append(&quot;=\&quot;&quot;).append(value).append(&quot;\&quot;&quot;);</span>
            }
        }

<span class="fc bfc" id="L121" title="All 2 branches covered.">        if (type == Tag.EMPTY) {</span>
<span class="fc" id="L122">            out.append(&quot;/&gt;&quot;);</span>
        } else {
<span class="fc" id="L124">            out.append('&gt;');</span>
        }
<span class="fc" id="L126">        buffer.insert(position, StringSitemeshBuffer.createBufferFragment(out.toString()));</span>
<span class="fc" id="L127">    }</span>

    @Override
    public boolean equals(Object o) {
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (this == o) {</span>
<span class="nc" id="L132">            return true;</span>
        }
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (!(o instanceof CustomTag)) {</span>
<span class="nc" id="L135">            return false;</span>
        }

<span class="nc" id="L138">        final CustomTag customTag = (CustomTag) o;</span>

<span class="nc bnc" id="L140" title="All 4 branches missed.">        if ((type != customTag.type)</span>
<span class="nc bnc" id="L141" title="All 6 branches missed.">                || (attributes != null ? !Arrays.equals(attributes, customTag.attributes)</span>
                        : customTag.attributes != null)
<span class="nc bnc" id="L143" title="All 4 branches missed.">                || (name != null ? !name.equals(customTag.name) : customTag.name != null)) {</span>
<span class="nc" id="L144">            return false;</span>
        }

<span class="nc" id="L147">        return true;</span>
    }

    @Override
    public int hashCode() {
<span class="nc bnc" id="L152" title="All 2 branches missed.">        int result = attributes != null ? attributes.hashCode() : 0;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        result = 29 * result + (name != null ? name.hashCode() : 0);</span>
<span class="nc" id="L154">        return 29 * result + type;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L159">        return getContents();</span>
    }

    // ---------- Standard methods to implement Tag interface ------

    @Override
    public int getAttributeCount() {
<span class="fc" id="L166">        return attributeCount / 2;</span>
    }

    @Override
    public int getAttributeIndex(String name, boolean caseSensitive) {
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        if (attributes == null) {</span>
<span class="nc" id="L172">            return -1;</span>
        }
<span class="fc" id="L174">        final int len = attributeCount;</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">        for (int i = 0; i &lt; len; i += 2) {</span>
<span class="fc" id="L176">            final String current = attributes[i];</span>
<span class="fc bfc" id="L177" title="All 6 branches covered.">            if (caseSensitive ? name.equals(current) : name.equalsIgnoreCase(current)) {</span>
<span class="fc" id="L178">                return i / 2;</span>
            }
        }
<span class="fc" id="L181">        return -1;</span>
    }

    @Override
    public String getAttributeName(int index) {
<span class="fc" id="L186">        return attributes[index * 2];</span>
    }

    @Override
    public String getAttributeValue(int index) {
<span class="fc" id="L191">        return attributes[index * 2 + 1];</span>
    }

    @Override
    public String getAttributeValue(String name, boolean caseSensitive) {
<span class="fc" id="L196">        int attributeIndex = getAttributeIndex(name, caseSensitive);</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">        if (attributeIndex == -1) {</span>
<span class="fc" id="L198">            return null;</span>
        }
<span class="fc" id="L200">        return attributes[attributeIndex * 2 + 1];</span>
    }

    @Override
    public boolean hasAttribute(String name, boolean caseSensitive) {
<span class="nc bnc" id="L205" title="All 2 branches missed.">        return getAttributeIndex(name, caseSensitive) &gt; -1;</span>
    }

    @Override
    public String getName() {
<span class="nc" id="L210">        return name;</span>
    }

    /**
     * Type of tag: &lt;br/&gt;
     * &amp;lt;blah&amp;gt; - Tag.OPEN&lt;br/&gt;
     * &amp;lt;/blah&amp;gt; - Tag.CLOSE&lt;br/&gt;
     * &amp;lt;blah/&amp;gt; - Tag.EMPTY&lt;br/&gt;
     */
    @Override
    public int getType() {
<span class="nc" id="L221">        return type;</span>
    }

    // ----------- Additional methods for changing a tag -----------

    /**
     * Change the name of the attribute.
     *
     * @param name
     *            the new name
     */
    public void setName(String name) {
<span class="pc bpc" id="L233" title="2 of 4 branches missed.">        if (name == null || name.length() == 0) {</span>
<span class="nc" id="L234">            throw new IllegalArgumentException(&quot;CustomTag requires a name&quot;);</span>
        }
<span class="fc" id="L236">        this.name = name;</span>
<span class="fc" id="L237">    }</span>

    /**
     * Change the type of the tag. Type of tag: &lt;br/&gt;
     * &amp;lt;blah&amp;gt; - Tag.OPEN&lt;br/&gt;
     * &amp;lt;/blah&amp;gt; - Tag.CLOSE&lt;br/&gt;
     * &amp;lt;blah/&amp;gt; - Tag.EMPTY&lt;br/&gt;
     *
     * @param type
     *            the new type
     */
    public void setType(int type) {
<span class="pc bpc" id="L249" title="1 of 6 branches missed.">        if ((type != Tag.OPEN) &amp;&amp; (type != Tag.CLOSE) &amp;&amp; (type != Tag.EMPTY)) {</span>
<span class="nc" id="L250">            throw new IllegalArgumentException(</span>
                    &quot;CustomTag must be of type Tag.OPEN, Tag.CLOSE or Tag.EMPTY - was &quot; + type);
        }
<span class="fc" id="L253">        this.type = type;</span>
<span class="fc" id="L254">    }</span>

    /**
     * Grow attributes.
     */
    private void growAttributes() {
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">        int newSize = attributes.length == 0 ? 4 : attributes.length * 2;</span>
<span class="fc" id="L261">        String[] newAttributes = new String[newSize];</span>
<span class="fc" id="L262">        System.arraycopy(attributes, 0, newAttributes, 0, attributes.length);</span>
<span class="fc" id="L263">        attributes = newAttributes;</span>
<span class="fc" id="L264">    }</span>

    /**
     * Add a new attribute. This does not check for the existence of an attribute with the same name, thus allowing
     * duplicate attributes.
     *
     * @param name
     *            Name of attribute to change.
     * @param value
     *            New value of attribute or null for an HTML style empty attribute.
     *
     * @return Index of new attribute.
     */
    public int addAttribute(String name, String value) {
<span class="fc bfc" id="L278" title="All 2 branches covered.">        if (attributeCount == attributes.length) {</span>
<span class="fc" id="L279">            growAttributes();</span>
        }
<span class="fc" id="L281">        attributes[attributeCount++] = name;</span>
<span class="fc" id="L282">        attributes[attributeCount++] = value;</span>
<span class="fc" id="L283">        return attributeCount / 2 - 1;</span>
    }

    /**
     * Change the value of an attribute, or add an attribute if it does not already exist.
     *
     * @param name
     *            Name of attribute to change.
     * @param caseSensitive
     *            Whether the name should be treated as case sensitive when searching for an existing value.
     * @param value
     *            New value of attribute or null for an HTML style empty attribute.
     */
    public void setAttributeValue(String name, boolean caseSensitive, String value) {
<span class="fc" id="L297">        int attributeIndex = getAttributeIndex(name, caseSensitive);</span>
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">        if (attributeIndex == -1) {</span>
<span class="nc" id="L299">            addAttribute(name, value);</span>
        } else {
<span class="fc" id="L301">            attributes[attributeIndex * 2 + 1] = value;</span>
        }
<span class="fc" id="L303">    }</span>

    /**
     * Change the name of an existing attribute.
     *
     * @param attributeIndex
     *            the attribute index
     * @param name
     *            the name
     */
    public void setAttributeName(int attributeIndex, String name) {
<span class="nc" id="L314">        attributes[attributeIndex * 2] = name;</span>
<span class="nc" id="L315">    }</span>

    /**
     * Change the value of an existing attribute. The value may be null for an HTML style empty attribute.
     *
     * @param attributeIndex
     *            the attribute index
     * @param value
     *            the value
     */
    public void setAttributeValue(int attributeIndex, String value) {
<span class="nc" id="L326">        attributes[attributeIndex * 2 + 1] = value;</span>
<span class="nc" id="L327">    }</span>

    /**
     * Remove an attribute.
     *
     * @param attributeIndex
     *            the attribute index
     */
    public void removeAttribute(int attributeIndex) {
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">        if (attributeIndex &gt; attributeCount / 2) {</span>
<span class="nc" id="L337">            throw new ArrayIndexOutOfBoundsException(</span>
                    &quot;Cannot remove attribute at index &quot; + attributeIndex + &quot;, max index is &quot; + attributeCount / 2);
        }
        // shift everything down one and null the last two
<span class="fc" id="L341">        String[] newAttributes = new String[attributes.length - 2];</span>
<span class="fc" id="L342">        System.arraycopy(attributes, 0, newAttributes, 0, attributeIndex * 2);</span>
<span class="fc" id="L343">        int next = attributeIndex * 2 + 2;</span>
<span class="fc" id="L344">        System.arraycopy(attributes, next, newAttributes, attributeIndex * 2, attributes.length - next);</span>
<span class="fc" id="L345">        attributeCount = attributeCount - 2;</span>
<span class="fc" id="L346">        attributes = newAttributes;</span>
<span class="fc" id="L347">    }</span>

    /**
     * Change the value of an attribute, or add an attribute if it does not already exist.
     *
     * @param name
     *            Name of attribute to remove.
     * @param caseSensitive
     *            Whether the name should be treated as case sensitive.
     */
    public void removeAttribute(String name, boolean caseSensitive) {
<span class="fc" id="L358">        int attributeIndex = getAttributeIndex(name, caseSensitive);</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">        if (attributeIndex == -1) {</span>
<span class="nc" id="L360">            throw new IllegalArgumentException(&quot;Attribute &quot; + name + &quot; not found&quot;);</span>
        }
<span class="fc" id="L362">        removeAttribute(attributeIndex);</span>
<span class="fc" id="L363">    }</span>

    @Override
    public int getPosition() {
<span class="nc" id="L367">        return 0;</span>
    }

    @Override
    public int getLength() {
<span class="nc" id="L372">        return 0;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>